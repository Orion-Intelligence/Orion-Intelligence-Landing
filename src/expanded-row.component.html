<div class="d-flex justify-content-center align-items-start w-100 min-vh-100">
  <div class="w-100 main-container rounded-3">
    <div class="w-100 card-main rounded-3">

      <div class="d-flex justify-content-between align-items-center py-3 px-4 card-header rounded-top-3">
        <div class="ioc-badge-wrapper p-1 rounded-2">
          <span class="d-block ioc-badge py-1 px-3 font-mono fw-bold text-white rounded-1">{{ result?.rank_index || 'IOC-XXX' }}</span>
        </div>
        <div class="d-flex align-items-center gap-2">
          <button (click)="downloadReport()" class="header-button p-2 rounded-2">
            <i class="bi bi-download"></i>
            <span class="tooltip-text">Download Report</span>
          </button>
          <span class="font-mono fw-semibold text-gray-500 ps-2">{{ result?.year || '2024' }}</span>
        </div>
      </div>

      <div class="small fw-bold text-blue-500 text-uppercase section-header mt-5 mb-4 d-flex align-items-baseline gap-2 px-4">
        <i class="bi bi-card-list"></i>
        <span>Metadata</span>
        <div class="section-header-line"></div>
      </div>

      <div class="px-4">
        <div class="row g-3">
          <div class="col-12 col-md-6">
            <div class="metadata-item rounded-3 d-flex align-items-center justify-content-between gap-3 px-3 py-2">
              <div class="d-flex align-items-center gap-4 w-100" style="min-width: 0;">
                <div class="item-label small fw-bold text-gray-400 text-uppercase d-flex align-items-center gap-2 flex-shrink-0 pe-4">
                  <i class="bi bi-calendar-event"></i>
                  <span class="text-truncate">Date</span>
                  <span class="tooltip-text">{{ tooltipMap['m_date'] || 'No description available.' }}</span>
                </div>
                <div class="flex-grow-1" style="min-width: 0;">
                  <span class="small fw-medium text-white break-all">{{ result?.m_date || '-' }}</span>
                </div>
              </div>
              <button class="copy-btn p-2 rounded-2 flex-shrink-0" (click)="copyValue(result?.m_date)" [class.copied]="copiedValue() === result?.m_date">
                <i class="bi" [class.bi-clipboard-check-fill]="copiedValue() === result?.m_date" [class.bi-clipboard]="copiedValue() !== result?.m_date"></i>
                <span class="tooltip-text">{{ copiedValue() === result?.m_date ? 'Copied!' : 'Copy' }}</span>
              </button>
            </div>
          </div>
          <div class="col-12 col-md-6">
            <div class="metadata-item rounded-3 d-flex align-items-center justify-content-between gap-3 px-3 py-2">
              <div class="d-flex align-items-center gap-4 w-100" style="min-width: 0;">
                <div class="item-label small fw-bold text-gray-400 text-uppercase d-flex align-items-center gap-2 flex-shrink-0 pe-4">
                  <i class="bi bi-file-earmark-text"></i>
                  <span class="text-truncate">File</span>
                  <span class="tooltip-text">{{ tooltipMap['m_file'] || 'No description available.' }}</span>
                </div>
                <div class="flex-grow-1" style="min-width: 0;">
                  <span class="small fw-medium text-white break-all">{{ result?.m_file || '-' }}</span>
                </div>
              </div>
              <button class="copy-btn p-2 rounded-2 flex-shrink-0" (click)="copyValue(result?.m_file)" [class.copied]="copiedValue() === result?.m_file">
                <i class="bi" [class.bi-clipboard-check-fill]="copiedValue() === result?.m_file" [class.bi-clipboard]="copiedValue() !== result?.m_file"></i>
                <span class="tooltip-text">{{ copiedValue() === result?.m_file ? 'Copied!' : 'Copy' }}</span>
              </button>
            </div>
          </div>
          <div class="col-12 col-md-6">
            <div class="metadata-item rounded-3 d-flex align-items-center justify-content-between gap-3 px-3 py-2">
              <div class="d-flex align-items-center gap-4 w-100" style="min-width: 0;">
                <div class="item-label small fw-bold text-gray-400 text-uppercase d-flex align-items-center gap-2 flex-shrink-0 pe-4">
                  <i class="bi bi-globe"></i>
                  <span class="text-truncate">Root Domain</span>
                  <span class="tooltip-text">{{ tooltipMap['m_root_domain'] || 'No description available.' }}</span>
                </div>
                <div class="flex-grow-1" style="min-width: 0;">
                  <span class="small fw-medium text-white break-all">{{ result?.m_root_domain?.[0] || '-' }}</span>
                </div>
              </div>
              <button class="copy-btn p-2 rounded-2 flex-shrink-0" (click)="copyValue(result?.m_root_domain?.[0])" [class.copied]="copiedValue() === result?.m_root_domain?.[0]">
                <i class="bi" [class.bi-clipboard-check-fill]="copiedValue() === result?.m_root_domain?.[0]" [class.bi-clipboard]="copiedValue() !== result?.m_root_domain?.[0]"></i>
                <span class="tooltip-text">{{ copiedValue() === result?.m_root_domain?.[0] ? 'Copied!' : 'Copy' }}</span>
              </button>
            </div>
          </div>
          <div class="col-12 col-md-6">
            <div class="metadata-item rounded-3 d-flex align-items-center justify-content-between gap-3 px-3 py-2">
              <div class="d-flex align-items-center gap-4 w-100" style="min-width: 0;">
                <div class="item-label small fw-bold text-gray-400 text-uppercase d-flex align-items-center gap-2 flex-shrink-0 pe-4">
                  <i class="bi bi-broadcast-pin"></i>
                  <span class="text-truncate">Channel</span>
                  <span class="tooltip-text">{{ tooltipMap['m_channel'] || 'No description available.' }}</span>
                </div>
                <div class="flex-grow-1" style="min-width: 0;">
                  <span class="small fw-medium text-white break-all">{{ result?.m_channel || '-' }}</span>
                </div>
              </div>
              <button class="copy-btn p-2 rounded-2 flex-shrink-0" (click)="copyValue(result?.m_channel)" [class.copied]="copiedValue() === result?.m_channel">
                <i class="bi" [class.bi-clipboard-check-fill]="copiedValue() === result?.m_channel" [class.bi-clipboard]="copiedValue() !== result?.m_channel"></i>
                <span class="tooltip-text">{{ copiedValue() === result?.m_channel ? 'Copied!' : 'Copy' }}</span>
              </button>
            </div>
          </div>
          <div class="col-12">
            <div class="metadata-item rounded-3 d-flex align-items-center justify-content-between gap-3 px-3 py-2">
              <div class="d-flex align-items-center gap-4 w-100" style="min-width: 0;">
                <div class="item-label small fw-bold text-gray-400 text-uppercase d-flex align-items-center gap-2 flex-shrink-0 pe-4">
                  <i class="bi bi-box-seam"></i>
                  <span class="text-truncate">Source</span>
                  <span class="tooltip-text">{{ tooltipMap['m_source'] || 'No description available.' }}</span>
                </div>
                <div class="flex-grow-1" style="min-width: 0;">
                  <span class="small fw-medium text-white break-all">{{ result?.m_source || '-' }}</span>
                </div>
              </div>
              <button class="copy-btn p-2 rounded-2 flex-shrink-0" (click)="copyValue(result?.m_source)" [class.copied]="copiedValue() === result?.m_source">
                <i class="bi" [class.bi-clipboard-check-fill]="copiedValue() === result?.m_source" [class.bi-clipboard]="copiedValue() !== result?.m_source"></i>
                <span class="tooltip-text">{{ copiedValue() === result?.m_source ? 'Copied!' : 'Copy' }}</span>
              </button>
            </div>
          </div>
        </div>
      </div>

      <div class="small fw-bold text-blue-500 text-uppercase section-header mt-5 mb-4 d-flex align-items-baseline gap-2 px-4">
        <i class="bi bi-person-vcard"></i>
        <span>Identity Intelligence</span>
        <div class="section-header-line"></div>
      </div>

      <div class="px-4">
        <div class="row g-3">
          <div class="col-12">
            <div class="identity-item rounded-3 d-flex align-items-center justify-content-between gap-3 px-3 py-2">
              <div class="d-flex align-items-center gap-4 w-100" style="min-width: 0;">
                <div class="item-label small fw-bold text-gray-400 text-uppercase d-flex align-items-center gap-2 flex-shrink-0 pe-4">
                  <i class="bi bi-link-45deg"></i><span class="text-truncate">Malicious URL</span>
                  <span class="tooltip-text">{{ tooltipMap['m_url'] }}</span>
                </div>
                <div class="flex-grow-1" style="min-width: 0;">
                  <a [href]="result?.m_url" target="_blank" rel="noopener noreferrer" class="small fw-medium text-white break-all text-decoration-none hover-link-primary">{{ result?.m_url || '-' }}</a>
                </div>
              </div>
              <button class="copy-btn p-2 rounded-2 flex-shrink-0" (click)="copyValue(result?.m_url)" [class.copied]="copiedValue() === result?.m_url">
                <i class="bi" [class.bi-clipboard-check-fill]="copiedValue() === result?.m_url" [class.bi-clipboard]="copiedValue() !== result?.m_url"></i>
                <span class="tooltip-text">{{ copiedValue() === result?.m_url ? 'Copied!' : 'Copy' }}</span>
              </button>
            </div>
          </div>
          <div class="col-12">
            <div class="identity-item rounded-3 d-flex flex-column align-items-start gap-2 px-3 py-2">
              <div class="d-flex justify-content-between w-100 align-items-center">
                <div class="item-label small fw-bold text-gray-400 text-uppercase d-flex align-items-center gap-2 border-0 p-0" style="width: auto;">
                  <i class="bi bi-info-circle"></i><span>Description</span>
                  <span class="tooltip-text">{{ tooltipMap['m_important_content'] }}</span>
                </div>
                <button class="copy-btn p-2 rounded-2 flex-shrink-0" (click)="copyValue(result?.m_important_content)" [class.copied]="copiedValue() === result?.m_important_content">
                  <i class="bi" [class.bi-clipboard-check-fill]="copiedValue() === result?.m_important_content" [class.bi-clipboard]="copiedValue() !== result?.m_important_content"></i>
                  <span class="tooltip-text">{{ copiedValue() === result?.m_important_content ? 'Copied!' : 'Copy' }}</span>
                </button>
              </div>
              <p class="small fw-medium text-white break-words w-100 mb-0">{{ result?.m_important_content || '-' }}</p>
            </div>
          </div>
          <div class="col-12 col-md-6">
            <div class="identity-item rounded-3 d-flex align-items-center justify-content-between gap-3 px-3 py-2">
              <div class="d-flex align-items-center gap-4 w-100" style="min-width: 0;">
                <div class="item-label small fw-bold text-gray-400 text-uppercase d-flex align-items-center gap-2 flex-shrink-0 pe-4">
                  <i class="bi bi-envelope"></i><span class="text-truncate">Email ID</span>
                  <span class="tooltip-text">{{ tooltipMap['m_email_identifier'] }}</span>
                </div>
                <div class="flex-grow-1" style="min-width: 0;">
                  <span class="small fw-medium text-white break-all">{{ result?.m_email_identifier || '-' }}</span>
                </div>
              </div>
              <button class="copy-btn p-2 rounded-2 flex-shrink-0" (click)="copyValue(result?.m_email_identifier)" [class.copied]="copiedValue() === result?.m_email_identifier">
                <i class="bi" [class.bi-clipboard-check-fill]="copiedValue() === result?.m_email_identifier" [class.bi-clipboard]="copiedValue() !== result?.m_email_identifier"></i>
                <span class="tooltip-text">{{ copiedValue() === result?.m_email_identifier ? 'Copied!' : 'Copy' }}</span>
              </button>
            </div>
          </div>
          <div class="col-12 col-md-6">
            <div class="identity-item rounded-3 d-flex align-items-center justify-content-between gap-3 px-3 py-2">
              <div class="d-flex align-items-center gap-4 w-100" style="min-width: 0;">
                <div class="item-label small fw-bold text-gray-400 text-uppercase d-flex align-items-center gap-2 flex-shrink-0 pe-4">
                  <i class="bi bi-bullseye"></i><span class="text-truncate">Target Domain</span>
                  <span class="tooltip-text">{{ tooltipMap['m_target_domain'] }}</span>
                </div>
                <div class="flex-grow-1" style="min-width: 0;">
                  <span class="small fw-medium text-white break-all">{{ result?.m_target_domain || '-' }}</span>
                </div>
              </div>
              <button class="copy-btn p-2 rounded-2 flex-shrink-0" (click)="copyValue(result?.m_target_domain)" [class.copied]="copiedValue() === result?.m_target_domain">
                <i class="bi" [class.bi-clipboard-check-fill]="copiedValue() === result?.m_target_domain" [class.bi-clipboard]="copiedValue() !== result?.m_target_domain"></i>
                <span class="tooltip-text">{{ copiedValue() === result?.m_target_domain ? 'Copied!' : 'Copy' }}</span>
              </button>
            </div>
          </div>
          <div class="col-12">
            <div class="identity-item password-item rounded-3 d-flex align-items-center justify-content-between gap-3 px-3 py-2">
              <div class="d-flex align-items-center gap-4 w-100" style="min-width: 0;">
                <div class="item-label small fw-bold text-gray-400 text-uppercase d-flex align-items-center gap-2 flex-shrink-0 pe-4">
                  <button (click)="togglePasswordVisibility()" class="btn btn-link p-0 border-0 password-toggle-btn" aria-label="Toggle password visibility"><i class="bi" [class.bi-eye-slash]="passwordVisible()" [class.bi-eye]="!passwordVisible()"></i></button>
                  <span class="text-truncate">Password</span>
                  <span class="tooltip-text">{{ tooltipMap['m_password'] }}</span>
                </div>
                <div class="flex-grow-1" style="min-width: 0;">
                  <span class="font-mono small fw-semibold text-white break-all" [style.letter-spacing]="!passwordVisible() ? '0.2em' : 'normal'">{{ passwordVisible() ? result?.m_password : '••••••••••••' }}</span>
                </div>
              </div>
              <button class="copy-btn p-2 rounded-2 flex-shrink-0" (click)="copyValue(result?.m_password)" [class.copied]="copiedValue() === result?.m_password">
                <i class="bi" [class.bi-clipboard-check-fill]="copiedValue() === result?.m_password" [class.bi-clipboard]="copiedValue() !== result?.m_password"></i>
                <span class="tooltip-text">{{ copiedValue() === result?.m_password ? 'Copied!' : 'Copy' }}</span>
              </button>
            </div>
          </div>
        </div>
      </div>
      
      <div 
        class="section-toggle-wrapper text-emerald-500 mt-5" 
        [class.mb-4]="!telemetrySectionVisible()"
        (click)="toggleTelemetrySection()" 
        role="button" 
        tabindex="0" 
        (keydown.enter)="toggleTelemetrySection()" 
        (keydown.space)="toggleTelemetrySection()"
        [attr.aria-expanded]="telemetrySectionVisible()">
        <div class="small fw-bold text-uppercase section-header d-flex align-items-baseline gap-2 px-4">
          <i class="bi bi-bar-chart-line"></i>
          <span>Metadata Telemetry Array</span>
          <span class="tag-count-badge small py-1 px-2 rounded-pill font-mono">{{ totalTagsCount }}</span>
          <button *ngIf="totalTagsCount > 0" (click)="copyAllTelemetry(); $event.stopPropagation()" class="header-button p-2 rounded-2 ms-2" [class.text-emerald-500]="copiedAll()" [style.border-color]="copiedAll() ? '#10b981' : null">
            <i class="bi" [class.bi-clipboard-check-fill]="copiedAll()" [class.bi-clipboard-plus]="!copiedAll()"></i>
            <span class="tooltip-text">{{ copiedAll() ? 'Copied All!' : 'Copy All Values' }}</span>
          </button>
          <div class="section-header-line-emerald"></div>
        </div>
        <i class="bi chevron-icon" [class.bi-chevron-up]="telemetrySectionVisible()" [class.bi-chevron-down]="!telemetrySectionVisible()"></i>
      </div>

      <div *ngIf="telemetrySectionVisible()" class="animate-expand">
        <ng-container *ngIf="tagGroups.length > 0; else noTelemetry">
          <div class="px-4 pb-5">
            <div class="row g-2 row-cols-2 row-cols-sm-3 row-cols-lg-5">
              <div *ngFor="let group of tagGroups; trackBy: trackGroupByKey" class="col">
                <button
                  (click)="toggleGroup(group.key)"
                  class="tag-group-button btn w-100 text-start d-flex justify-content-between align-items-center small gap-2 py-2 px-3 rounded-2"
                  [class.selected]="selectedGroupKey() === group.key"
                  [class.priority]="group.isPriority && selectedGroupKey() !== group.key"
                >
                  <span class="d-flex align-items-center gap-2" style="min-width: 0;">
                    <i *ngIf="group.isPriority" class="bi bi-star-fill flex-shrink-0 text-warning"></i>
                    <i [class]="'bi ' + (iconMap[group.icon] || 'bi-question-circle') + ' flex-shrink-0 tag-icon'"></i>
                    <span class="fw-semibold tag-label">{{ group.label }}</span>
                  </span>
                  <span class="small rounded-2 h-auto px-1 flex-shrink-0 d-inline-flex align-items-center justify-content-center fw-bold font-mono count-badge">
                    {{ group.count }}
                  </span>
                </button>
              </div>
            </div>
          </div>
        </ng-container>
        <ng-template #noTelemetry>
          <div class="px-4 pb-5 text-gray-500">
            <span>No Telemetry Found</span>
          </div>
        </ng-template>
  
        <div *ngIf="selectedGroup as group" class="px-4 pb-5 animate-slide-in">
          <div class="details-panel rounded-3 p-4">
            <div class="d-flex justify-content-between align-items-center mb-4 pb-3 details-header">
              <div class="d-flex align-items-center gap-2 small fw-bold text-gray-400">
                <i *ngIf="group.isPriority" class="bi bi-star-fill flex-shrink-0 text-warning"></i>
                <i [class]="'bi ' + (iconMap[group.icon] || 'bi-question-circle') + ' text-blue-500'"></i>
                <span>{{ group.label }} Details</span>
              </div>
              <button class="btn btn-link p-1 rounded-circle close-details-btn" (click)="closeDetails()" aria-label="Close details">
                <i class="bi bi-chevron-up"></i>
              </button>
            </div>
            <div class="details-grid">
              <div *ngFor="let value of group.values; trackBy: trackValueByValue" class="details-item font-mono py-2 px-3 rounded-2 small text-white break-all d-flex align-items-center justify-content-between gap-2">
                <span class="flex-grow-1" style="min-width: 0;">{{ value }}</span>
                <button class="copy-btn p-1 rounded-2 flex-shrink-0" (click)="copyValue(value)" [class.copied]="copiedValue() === value">
                  <i class="bi" style="font-size: 0.75rem;" [class.bi-clipboard-check-fill]="copiedValue() === value" [class.bi-clipboard]="copiedValue() !== value"></i>
                  <span class="tooltip-text">{{ copiedValue() === value ? 'Copied!' : 'Copy' }}</span>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>